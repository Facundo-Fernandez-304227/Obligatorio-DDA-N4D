<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tablero de control del propietario</title>
  <link rel="stylesheet" href="obligatorioCss.css">
  <script src="utilesVista.js" defer></script>
  <script src="vistaWeb.js"></script>
  <script src="sse.js"></script>


</head>

<body class="page-gestion-contactos">

  <div class="container">

    <!-- Título y salir -->
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2>Tablero de control del propietario</h2>
      <a href="index.html" style="color: #b91c1c; font-weight: bold; text-decoration: none;">Salir</a>
    </div>

    <!-- Resumen -->
    <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
      <h3>Resumen del propietario</h3>
      <div style="display: flex; flex-wrap: wrap; justify-content: space-between;">
        <div style="flex: 1; min-width: 200px;">
          <label>Nombre completo:</label>
          <p id="nombreCompleto">---</p>
        </div>
        <div style="flex: 1; min-width: 200px;">
          <label>Estado:</label>
          <p id="estado">---</p>
        </div>
        <div style="flex: 1; min-width: 200px;">
          <label>Saldo actual:</label>
          <p id="saldo" style="font-weight: bold; color: green;">$ 0,00</p>
        </div>
      </div>
    </div>

    <!-- Bonificaciones y vehículos -->
    <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px;">
      <div style="flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 8px;">
        <h3>Bonificaciones asignadas</h3>
        <div id="tablaBonificaciones">Cargando...</div>
      </div>

      <div style="flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 8px;">
        <h3>Vehículos registrados</h3>
        <div id="tablaVehiculos"></div>
      </div>
    </div>

    <!-- Tránsitos -->
    <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
      <h3>Tránsitos realizados</h3>
      <div id="tablaTransitos">Cargando...</div>
    </div>

    <!-- Notificaciones -->
    <div style="background: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
      <h3>Notificaciones del sistema</h3>
      <div id="tablaNotificaciones">Cargando...</div>
      <div style="text-align: right; margin-top: 10px;">
        <button id="btnBorrarNotificaciones" class="btn-acceder" style="background-color: #dc2626;">
          Borrar notificaciones
        </button>
      </div>
    </div>
  </div>

  <script>
    // Al cargar la página pide los datos al backend
    urlIniciarVista = "/propietario/tablero";
    urlRegistroSSE = "/propietario/registrarSSE";


    function procesarMensajeSSE(mensaje) {

      //Si el mensaje es refrescar tablero va a refrescar la pagina menu propetario
      if (mensaje.mensaje === "REFRESCAR_TABLERO") {
        submit("/propietario/tablero", "", "GET");
        return;
      }

      //Sino, es una notificación normal
      agregarNotificacionATabla(mensaje);
    }


    // esto del IFRAME va solo si quiero renderizar otro html dentro de mi html, en realidad nosotros solo queremos insertar los datos que ya nos trajo el SSEE
    //En nuestro caso SSEE se conecta a la vista propietario que es quien recibe las notificaciones, no necesitamos que quede activa una session siempre porque este
    //Menu solo tiene un html. En el caso de la agenda era porque se iban renderizando diferentes html entonces la conexion SSEE se "dejaba viva" en el menu principal.
    /*
      console.log("Mensaje SSE recibido en menuPropietario.html:", mensaje);
                var iframe = document.getElementById('contenidoFrame');
                var iframeWindow = iframe.contentWindow;
                iframeWindow.procesarResultadosSubmit(mensaje); //asumo que el iFrame tiene vistaWeb.js incluida
          */

    function agregarNotificacionATabla(noti) {
      const cont = document.getElementById("tablaNotificaciones");

      // Si no hay tabla, la creo
      if (!cont.querySelector("table")) {
        cont.innerHTML = crearTablaDesdeJson([noti]);
        return;
      }

      // Agregar solo una fila.
      const tabla = cont.querySelector("table");
      const tbody = tabla.querySelector("tbody");

      // Crear nueva fila
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${noti.mensaje}</td>
        <td>${noti.fechaEnvio}</td>
    `;
      //Agrego la noti como hija
      tbody.appendChild(tr);
    }





    //Se ejecuta cuando se cierra la conexion desde el servidor
    //Si no se define esta funcion, por defecto se "borra" la pagina 
    function conexionSSECerrada(event) {
      cerrar();
    }


    function procesarErrorSubmit(status, text) {
      alert("Error al cargar el tablero (" + status + ")");
      console.error(text);
    }

    // Cargar los datos del propietario
    function mostrar_tablero(datos) {

      console.log("Datos recibidos en mostrar_tablero:", datos);
      console.log("Notificaciones en DTO: ", datos.notificaciones);


      document.getElementById("nombreCompleto").textContent = datos.nombreCompleto || "---";
      document.getElementById("estado").textContent = datos.estado || "---";
      document.getElementById("saldo").textContent = "$ " + (datos.saldoActual || "0,00");

      document.getElementById("tablaBonificaciones").innerHTML =
        datos.bonificaciones && datos.bonificaciones.length > 0
          ? crearTablaDesdeJson(datos.bonificaciones)
          : "<p>No hay bonificaciones asignadas.</p>";

      document.getElementById("tablaVehiculos").innerHTML =
        datos.vehiculos && datos.vehiculos.length > 0
          ? crearTablaDesdeJson(datos.vehiculos)
          : "<p>No hay vehículos registrados.</p>";

      document.getElementById("tablaTransitos").innerHTML =
        datos.transitos && datos.transitos.length > 0
          ? crearTablaDesdeJson(datos.transitos)
          : "<p>No hay tránsitos registrados.</p>";

      document.getElementById("tablaNotificaciones").innerHTML =
        datos.notificaciones && datos.notificaciones.length > 0
          ? crearTablaDesdeJson(datos.notificaciones)
          : "<p>No hay notificaciones para mostrar.</p>";
    }

    function mostrar_notificacionesBorradas(mensaje) {
      //VACIO TABLA EN DOM
      document.getElementById("tablaNotificaciones").innerHTML =
        "<p>No hay notificaciones para mostrar.</p>";

      //VER ESTO REVISAR
      if (typeof mostrarMensaje === "function") {
        mostrarMensaje(mensaje); // "Se borraron las notificaciones correctamente."
      } else {
        alert(mensaje); // fallback por las dudas
      }
    }

    //OBRRAR LAS NOTIFICACIONES EN EL BACKEND

    document.getElementById("btnBorrarNotificaciones").onclick = function () {

      submit("/propietario/borrarNotificaciones", "");
    };
  </script>

</body>

</html>